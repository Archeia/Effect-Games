////
// Joe's Misc JavaScript Tools
// Copyright (c) 2008 Joseph Huckaby
////

var images_uri = 'images';
var icons_uri = images_uri + '/icons';
var protocol = location.protocol.match(/https/i) ? 'https' : 'http';

// browser checks
var ua = navigator.userAgent;
var safari = !!ua.match(/Safari/);
var safari3 = safari && (!!ua.match(/Version\/[3456789]/) || window.chrome);
var safari2 = (safari && !safari3 && !window.chrome);
var ie = !!ua.match(/MSIE/);
var ie7 = ie && !!ua.match(/MSIE\s+[789]/);
var ie6 = (ie && !ie7);
var moz = !safari && !ie;
var op = !!window.opera;
var mac = !!ua.match(/Mac/i);
var ff = !!ua.match(/Firefox/i);
var ff2 = ff && !!ua.match(/Firefox\/2/);
var ff3 = ff && !!ua.match(/Firefox\/[3456789]/);

var months = [
	[ 1, 'January' ], [ 2, 'February' ], [ 3, 'March' ], [ 4, 'April' ],
	[ 5, 'May' ], [ 6, 'June' ], [ 7, 'July' ], [ 8, 'August' ],
	[ 9, 'September' ], [ 10, 'October', ], [ 11, 'November', ],
	[ 12, 'December' ]
];

function $(thingy) {
	// universal DOM lookup function, extends object with hide/show/addClass/removeClass
	// can pass in ID or actual DOM object reference
	var obj = (typeof(thingy) == 'string') ? document.getElementById(thingy) : thingy;
	if (obj && !obj.hide) {
		obj.hide = function() { this.style.display = 'none'; };
		obj.show = function() { this.style.display = ''; };
		obj.addClass = function(name) { this.removeClass(name); this.className += ' ' + name; };
		obj.removeClass = function(name) { this.className = this.className.replace( new RegExp("\\s*" + name + "\\s*"), ""); };
	}
	return obj;
}

function parseQueryString(queryString) {
	// parse query string into object
	var pair = null;
	var queryObject = new Object();
	queryString = queryString.replace(/^.*\?(.+)$/,'$1');
	
	while ((pair = queryString.match(/(\w+)=([^\&]*)\&?/)) && pair[0].length) {
		queryString = queryString.substring( pair[0].length );
		pair[2] = unescape(pair[2]);
		if (/^\-?\d+$/.test(pair[2])) pair[2] = parseInt(pair[2]);
		
		if (typeof(queryObject[pair[1]]) != 'undefined') {
			always_array( queryObject, pair[1] );
			array_push( queryObject[pair[1]], pair[2] );
		}
		else queryObject[pair[1]] = pair[2];
	}
	
	return queryObject;
}

function composeQueryString(queryObj) {
	// compose key/value pairs into query string
	// supports duplicate keys (i.e. arrays)
	var qs = '';
	for (var key in queryObj) {
		var values = always_array(queryObj[key]);
		for (var idx = 0, len = values.length; idx < len; idx++) {
			qs += (qs.length ? '&' : '?') + escape(key) + '=' + escape(values[idx]);
		}
	}
	return qs;
}

function spacer(width, height) {
	// insert sized spacer gif image
	return '<img src="'+images_uri+'/spacer.gif" width="'+width+'" height="'+height+'">';
}

function solidify(obj) {
	// make object solid (i.e. not transparent)
	obj.style.opacity = '1.0';
	if (moz) obj.style.MozOpacity = '1.0';
	else if (ie) obj.style.filter = '';
}

function transify(obj) {
	// make object transparent (i.e. half opacity)
	obj.style.opacity = '0.5';
	if (moz) obj.style.MozOpacity = '0.5';
	else if (ie) obj.style.filter = 'alpha(opacity=50)';
}

function trans_icon(name, code) {
	// return html for single icon button that has opacity rollover effect
	var size = 16;
	var html = '<a href="javascript:void(' + code + ')">';
	html += '<img src="'+icons_uri+'/'+name+'.gif" width='+size+' height='+size+' border=0';
	html += ' style="opacity:0.5; moz-opacity:0.5; filter:alpha(opacity=50);"';
	html += ' onMouseOver="solidify(this)"';
	html += ' onMouseOut="transify(this)"';
	html += '>';
	html += '</a>';
	return html;
}

function icon(name, label, code, status_text, id, hspace) {
	// return html for rendering icon image, given name
	if (!window.icons_uri) return 'icons_uri not set!';
	var html = '';
	var ahref = '';
	var size = 16;
	
	if (!id) id = '';
	if (!status_text && label) status_text = label;
	if (!status_text) status_text = '';
	if (name.indexOf('_mini') > -1) size = 14;
	
	if (label) {
		html += '<table cellspacing=0 cellpadding=0 border=0><tr><td style="padding:0px" valign=center>';
	}
	if (code) {
		ahref = '<a href="javascript:void(' + code + 
			')" title="' + status_text + '">';
		html += ahref;
	}
	html += '<img id="'+id+'" src="'+icons_uri+'/'+name+'.gif" width='+size+' height='+size+' border=0>';

	if (code) html += '</a>';
	if (hspace) html += '&nbsp;';

	if (label) {
		html += '</td><td style="padding:0px" width=4>'+spacer(4,1)+'</td><td style="padding:0px" valign=center>';
		if (code) html += ahref;
		html += label;
		if (code) html += '</a>';
		html += '</td></tr></table>';
	}
	return html;
}

function code_link(code, html, status_text, force_hand) {
	// return formatted html link which executes code
	if (!status_text) status_text = html.toString().replace(/<.+?>/g, "");
	
	return '<a href="javascript:void(' + code + ')"' + 
		' title="' + status_text + '"' + 
		(force_hand ? ' style="cursor:hand"' : '') + 
		'>' + html + '</a>';
}

function set_section_visibility(id, visible) {
	// set section view flag to viewable or hidden

	var div = document.getElementById(id);
	var current_state = div.style.display;
	div.style.display = visible ? 'block' : 'none';
	
	var sc = document.getElementById('sc_' + id);
	if (sc) {
		var new_icon_name = visible ? 'minus' : 'plus';
		if (sc.src.indexOf('_mini') > -1) new_icon_name += '_mini';
		sc.src = icons_uri + '/' + new_icon_name + '.gif';
	}

	if (visible && !div.innerHTML.length && div.getAttribute('onExpand')) 
		eval( div.getAttribute('onExpand') );
}

function toggle_section(id) {
	// toggle expandable section on and off
	// also set icon src to match (minus or plus icon)
	
	var div = document.getElementById(id);
	var current_state = div.style.display;
	div.style.display = (current_state == 'block') ? 'none' : 'block';
	
	var sc = document.getElementById('sc_' + id);
	if (sc) {
		var new_icon_name = (current_state == 'block') ? 'plus' : 'minus';
		if (sc.src.indexOf('_mini') > -1) new_icon_name += '_mini';
		sc.src = icons_uri + '/' + new_icon_name + '.gif';
	}

	if (!div.innerHTML.length && div.getAttribute('onExpand')) 
		eval( div.getAttribute('onExpand') );
}

function section_control(id, expanded) {
	// generate plus/minus icon that expands/contracts
	// section with id given
	return icon(
		expanded ? 'minus' : 'plus', '', '', 'Toggle Section View', 'sc_' + id
	);
}

function get_text_from_bytes(bytes) {
	// convert raw bytes to english-readable format
	if (bytes >= 1024) {
		bytes = parseInt( (bytes / 1024) * 10 ) / 10;
		if (bytes >= 1024) {
			bytes = parseInt( (bytes / 1024) * 10 ) / 10;
			if (bytes >= 1024) {
				bytes = parseInt( (bytes / 1024) * 10 ) / 10;
				return bytes + ' GB';
			} else return bytes + ' MB';
		}
		else return bytes + ' K';
	}
	else return bytes + ' bytes';
}

function csv_to_hash(csv) {
	// convert comma-separated values into hash keys
	// with values set to 1
	if (!csv.length) return {};
	assert( arguments.length == 1, "Wrong number of arguments sent to csv_to_hash (" + arguments.length + ")" );

	var list = csv.split(/\,\s*/);
	var hash = {};
	
	for (var idx = 0, len = list.length; idx < len; idx++) {
		hash[ list[idx] ] = 1;
	}

	return hash;
}

function num_keys(hash) {
	// count the number of keys in a hash
	var count = 0;

	for (var a in hash) count++;

	return count;
}

function reverse_hash(a) {
	// reverse hash keys/values
	var c = {};
	for (var key in a) {
		c[ a[key] ] = key;
	}
	return c;
}

function append_to_callback(callback, code) {
	// here be stacy magic: add code given as string to
	// window callback -- works if window already has
	// callback code.  no return value.

	var new_code = '';
	
	if (window[callback]) {
		var old_code = window[callback].toString();
		new_code = code + ";\r" + old_code.substring(
			old_code.indexOf("{")+1, old_code.lastIndexOf("}") ) + "\r;";
	}
	else {
		new_code = code + ";";
	}
	window[callback] = new Function( new_code );
}

function progress_bar(args) {
	// render progress bar
	
	if (!args.counter_max) args.counter_max = 1;
	var x = parseInt( (args.counter * args.width) / args.counter_max );
	if (x < 0) x = 0;
	if (x > args.width) x = args.width;
	
	var html = '<table cellspacing=0 cellpadding=0 border=0><tr><td valign=center';
	if (!x) html += ' background="'+images_uri+'/b2_loop.gif"';
	html += '>';
	html += '<nobr>';
	if (x > 4) {
		var xtemp = x - 4;
		html += '<img src="'+images_uri+'/a1.gif" width=2 height='+args.height+'>';
		html += '<img src="'+images_uri+'/a2.gif" width='+xtemp+' height='+args.height+'>';
		html += '<img src="'+images_uri+'/a3.gif" width=2 height='+args.height+'>';
	}
	if (x < args.width - 4) {
		var xtemp = (args.width - x) - 4;
		var b2 = x ? "b2" : "spacer";
		html += '<img src="'+images_uri+'/b1.gif" width=2 height='+args.height+'>';
		html += '<img src="'+images_uri+'/'+b2+'.gif" width='+xtemp+' height='+args.height+'>';
		html += '<img src="'+images_uri+'/b3.gif" width=2 height='+args.height+'>';
	}
	html += '</nobr>';
	html += '</td>';
	if (args.show_percent) {
		var pct = parseInt( (args.counter * 100) / args.counter_max );
		if (pct < 0) pct = 0;
		if (pct > 100) pct = 100;
		html += '<td valign=center>&nbsp;' + pct + '%</td>';
	}
	html += '</tr></table>';
	
	return html;
}

var g_unique_id = 772; // magic number :-)
function get_unique_id() {
	// get unique numerical id for divs
	g_unique_id++;
	return g_unique_id;
}

function substitute(text, args) {
	// perform simple [placeholder] substitution using supplied
	// args object (or eval) and return transformed text
	if (!text) text = "";
	if (!args) args = {};

	while (text.indexOf('[') > -1) {
		var open_bracket = text.indexOf('[');
		var close_bracket = text.indexOf(']');

		var before = text.substring(0, open_bracket);
		var after = text.substring(close_bracket + 1, text.length);

		var name = text.substring( open_bracket + 1, close_bracket );
		var value = '';
		if (name.indexOf('/') == 0) value = lookup_path(name, args);
		else if (typeof(args[name]) != 'undefined') value = args[name];
		else if (!/^\w+$/.test(name)) value = eval(name);
		else value = '[' + name + ']';

		text = before + value + after;
	} // while text contains [

	return text;
}

function time_now() {
	// return the Epoch seconds for like right now
	var now = new Date();
	return parseInt( now.getTime() / 1000 );
}

function ucfirst(text) {
	// capitalize first character only, lower-case rest
	return text.substring(0, 1).toUpperCase() + text.substring(1, text.length).toLowerCase();
}

function text_to_html(text) {
	// simple conversion of \n to <br>
	// plus < and > entitizing
	if (!text) text = "";
	return encode_entities(text).replace(/\n/g, "\n<br>");
}

function html_to_text(html) {
	// simple conversion of html to plain text
	html = html.replace(/<\/(p|div|ul|ol|li|table|tr|dl|dd|dt|h\d)>/ig, "__ChBREAk__");
	html = html.replace(/<br\/?>/ig, "__ChBREAk__");
	html = html.replace(/<.+?>/g, "");
	html = html.replace(/__ChBREAk__/g, "<br/>");
	return html;
}

function image_rollover(img) {
	// given image object, insert "_hover" just before file extension
	// in src tag.  Replaces "_up".  no return value.
	img.src = img.src.replace(/_up(\.\w+)$/, "_over$1");
}

function image_rollout(img) {
	// given image object, remove "_hover" just before file extension
	// in src tag.  Replaces with "_up".  no return value.
	img.src = img.src.replace(/_over(\.\w+)$/, "_up$1");
}

function commify(number) {
	// add commas to integer, like 1,234,567
	// from: http://javascript.internet.com/messages/add-commas.html
	if (!number) number = 0;

	number = '' + number;
	if (number.length > 3) {
		var mod = number.length % 3;
		var output = (mod > 0 ? (number.substring(0,mod)) : '');
		for (i=0 ; i < Math.floor(number.length / 3); i++) {
			if ((mod == 0) && (i == 0))
				output += number.substring(mod+ 3 * i, mod + 3 * i + 3);
			else
				output+= ',' + number.substring(mod + 3 * i, mod + 3 * i + 3);
		}
		return (output);
	}
	else return number;
}

function hash_to_query(hash) {
	// convert hash to query string format
	var str = '';
	for (var key in hash) {
		if (str.length > 0) str += '&';
		str += key + '=' + escape(hash[key]);
	}
	return str;
}

function get_text_from_seconds(sec, abbrev, no_secondary) {
	// convert raw seconds to human-readable relative time
	var neg = '';
	sec = parseInt(sec);
	if (sec<0) { sec =- sec; neg = '-'; }
	
	var p_text = abbrev ? "sec" : "second";
	var p_amt = sec;
	var s_text = "";
	var s_amt = 0;
	
	if (sec > 59) {
		var min = parseInt(sec / 60);
		sec = sec % 60; 
		s_text = abbrev ? "sec" : "second"; 
		s_amt = sec; 
		p_text = abbrev ? "min" : "minute"; 
		p_amt = min;
		
		if (min > 59) {
			var hour = parseInt(min / 60);
			min = min % 60; 
			s_text = abbrev ? "min" : "minute"; 
			s_amt = min; 
			p_text = abbrev ? "hr" : "hour"; 
			p_amt = hour;
			
			if (hour > 23) {
				var day = parseInt(hour / 24);
				hour = hour % 24; 
				s_text = abbrev ? "hr" : "hour"; 
				s_amt = hour; 
				p_text = "day"; 
				p_amt = day;
				
				if (day > 29) {
					var month = parseInt(day / 30);
					day = day % 30; 
					s_text = "day"; 
					s_amt = day; 
					p_text = abbrev ? "mon" : "month"; 
					p_amt = month;
				} // day>29
			} // hour>23
		} // min>59
	} // sec>59
	
	var text = p_amt + "&nbsp;" + p_text;
	if ((p_amt != 1) && !abbrev) text += "s";
	if (s_amt && !no_secondary) {
		text += ", " + s_amt + "&nbsp;" + s_text;
		if ((s_amt != 1) && !abbrev) text += "s";
	}
	
	return(neg + text);
}

function get_nice_remaining_time(epoch_start, epoch_now, counter, counter_max, abbrev) {
	// estimate remaining time given starting epoch, a counter and the 
	// counter maximum (i.e. percent and 100 would work)
	// return in english-readable format
	
	if (counter == counter_max) return 'Complete';
	if (counter == 0) return 'n/a';
	
	var sec_remain = parseInt(((counter_max - counter) * (epoch_now - epoch_start)) / counter);
	
	return get_text_from_seconds( sec_remain, abbrev );
}

function dumper(obj, indent) {
	// return pretty-printed object tree
	var text = '';
		
	if (!indent) {
		text = "var obj = ";
		if (typeof(obj) == 'object' && typeof(obj.length) != 'undefined') text += "[\n";
		else text += "{\n";
		indent = 1;
	}
	
	var indentStr = '';
	for (var k=0; k<indent; k++) indentStr += "\t";
	
	for (var a in obj) {
		if (typeof(obj.length) != 'undefined') text += indentStr;
		else text += indentStr + a + ": ";
		
		if (typeof(obj[a]) == 'object') {
			if (obj[a] == null) {
				text += "null,\n";
			}
			else if (typeof(obj[a].length) != 'undefined') {
				text += "[\n" + dumper( obj[a], indent + 1) + indentStr + "],\n";
			}
			else {
				text += "{\n" + dumper( obj[a], indent + 1) + indentStr + "},\n";
			}
		}
		else if (typeof(obj[a]) == 'number') text += obj[a] + ",\n";
		else text += '"' + obj[a] + '",' + "\n";
	} // for a in obj
	
	if (indent == 1) {
		if (typeof(obj) == 'object' && typeof(obj.length) != 'undefined') text += "];\n";
		else text += "};\n";
	}

	return text;
}

function object_tree( title, obj, expanded ) {
	// render simple object tree with collapsable/expandable sections
	// use folder/file icons for hashes and keys
	var html = '';
	var id = 's_' + get_unique_id();

	html += '<table cellspacing=0 cellpadding=0 onClick="toggle_section(\'' + id + '\')"><tr>';
	html += '<td style="padding:0px" width=16>' + section_control(id, expanded) + '</td>';
	html += '<td style="padding:0px" width=16>' + icon('folder') + '</td><td style="padding:0px" width=2>' + spacer(2,1) + '</td>';
	html += '<td style="padding:0px"><font class=section_title><nobr><font color=blue style="cursor:pointer"><b>'+title+'</b></font></nobr></font></td>';
	html += '</tr></table>';

	html += '<div id="'+id+'" style="display:' + (expanded ? 'block' : 'none') + '">';
	html += '<table cellspacing=0 cellpadding=0><tr><td style="padding:0px" width=16>&nbsp;</td><td style="padding:0px">';
	
	html += '<table>';

	var sorted_keys = hash_keys_to_array(obj).sort();

	for (var idx in sorted_keys) {
		var key = sorted_keys[idx];

		if (typeof(obj[key]) == 'object') {
			html += '<tr><td style="padding:0px">';
			html += object_tree( key, obj[key], 0 );
			html += '</td></tr>';
		}
	}
	for (var idx in sorted_keys) {
		var key = sorted_keys[idx];

		if (typeof(obj[key]) != 'object') {
			html += '<tr><td style="padding:0px">';
			html += '<table cellspacing=0 cellpadding=0><tr><td style="padding:0px" width=16>&nbsp;</td><td style="padding:0px">';
			
			html += icon( 'file', '<b>' + key.toString().replace(/^\W+/, "") + ':</b> ' + obj[key] );
			// html += '<b>' + key.toString().replace(/^\W+/, "") + ':</b> ' + obj[key];
			
			html += '</td></tr></table>';
			html += '</td></tr>';
		}
	}
	html += '</table>';

	html += '</td></tr></table>';
	html += '</div>';
	return html;
}

function this_hour() {
	// return epoch seconds for normalized hour
	var now = new Date();
	var then = new Date(
		now.getFullYear(),
		now.getMonth(),
		now.getDate(),
		now.getHours(),
		0, 0, 0 );
	return parseInt( then.getTime() / 1000 );
}

function today_midnight() {
	// return epoch seconds for nearest midnight in past
	var now = new Date();
	var then = new Date(
		now.getFullYear(),
		now.getMonth(),
		now.getDate(),
		0, 0, 0, 0 );
	return parseInt( then.getTime() / 1000 );
}

function yesterday_midnight() {
	// return epoch seconds for yesterday's midnight
	var midnight = today_midnight();
	var yesterday = new Date( (midnight - 1) * 1000 );
	var then = new Date(
		yesterday.getFullYear(),
		yesterday.getMonth(),
		yesterday.getDate(),
		0, 0, 0, 0 );
	return parseInt( then.getTime() / 1000 );
}

function this_month_midnight() {
	// return epoch seconds for midnight on the 1st of this month
	var now = new Date();
	var then = new Date(
		now.getFullYear(),
		now.getMonth(),
		1, 0, 0, 0, 0 );
	return parseInt( then.getTime() / 1000 );
}

function last_month_midnight() {
	// return epoch seconds for midnight on the 1st of last month
	var this_month = this_month_midnight();
	var last_month = new Date( (this_month - 1) * 1000 );
	var then = new Date(
		last_month.getFullYear(),
		last_month.getMonth(),
		1, 0, 0, 0, 0 );
	return parseInt( then.getTime() / 1000 );
}

function get_date_args(epoch) {
	// return hash containing year, mon, mday, hour, min, sec
	// given epoch seconds
	var date = new Date( epoch * 1000 );
	var args = {
		year: date.getFullYear(),
		mon: date.getMonth() + 1,
		mday: date.getDate(),
		hour: date.getHours(),
		min: date.getMinutes(),
		sec: date.getSeconds(),
		msec: date.getMilliseconds()
	};
	if (args.hour >= 12) {
		args.ampm = 'pm';
		args.hour12 = args.hour - 12;
		if (!args.hour12) args.hour12 = 12;
	}
	else {
		args.ampm = 'am';
		args.hour12 = args.hour;
		if (!args.hour12) args.hour12 = 12;
	}
	return args;
}

function get_time_from_args(args) {
	// return epoch given args like those returned from get_date_args()
	var then = new Date(
		args.year,
		args.mon - 1,
		args.mday,
		args.hour,
		args.min,
		args.sec,
		0
	);
	return parseInt( then.getTime() / 1000 );
}

function normalize_time(epoch, zero_args) {
	// quantize time into any given precision
	// example hourly: { min:0, sec:0 }
	// daily: { hour:0, min:0, sec:0 }
	var args = get_date_args(epoch);
	for (key in zero_args) args[key] = zero_args[key];
	
	// mday is 1-based
	if (!args['mday']) args['mday'] = 1;
	
	return get_time_from_args(args);
}

function find_iframe_doc(id) {
	// locate document object in IFRAME
	var domObj = $(id);
	if (!domObj) return null;

	// locate document object inside IFRAME
	var doc = null;
	if (domObj.contentDocument)	doc = domObj.contentDocument; // For NS6
	else if (domObj.contentWindow) doc = domObj.contentWindow.document; // For IE5.5 and IE6
	else if (domObj.document) doc = eval(domObj.id+".document"); // For IE5
	
	return doc;
}

function rand_array(arr) {
	// return random element from array
	return arr[ parseInt(Math.random() * arr.length) ];
}

function find_elem_idx(arr, elem) {
	// Locate element inside of arrayref by value
	for (var idx = 0, len = arr.length; idx < len; idx++) {
		if (arr[idx] == elem) return idx;
	}
	
	return -1; // not found
}

function remove_from_array(arr, elem) {
	// Locate first element inside of arrayref by value, then remove it
	var idx = find_elem_idx(arr, elem);
	if (idx > -1) {
		array_splice( arr, idx, 1 );
		return 1;
	}
	return 0;
}

function remove_all_from_array(arr, elem) {
	// Locate ALL elements matching value, and remove ALL from array
	var done = 0;
	var found = 0;
	
	while (!done) {
		var idx = find_elem_idx(arr, elem);
		if (idx > -1) { array_splice(arr, idx, 1); found++; }
		else { done = 1; }
	}
	
	return found;
}

function getInnerWindowSize(dom) {
	// get size of inner window
	// From: http://www.howtocreate.co.uk/tutorials/javascript/browserwindow
	if (!dom) dom = window;
	var myWidth = 0, myHeight = 0;
	
	if( typeof( dom.innerWidth ) == 'number' ) {
		// Non-IE
		myWidth = dom.innerWidth;
		myHeight = dom.innerHeight;
	}
	else if( dom.document.documentElement && ( dom.document.documentElement.clientWidth || dom.document.documentElement.clientHeight ) ) {
		// IE 6+ in 'standards compliant mode'
		myWidth = dom.document.documentElement.clientWidth;
		myHeight = dom.document.documentElement.clientHeight;
	}
	else if( dom.document.body && ( dom.document.body.clientWidth || dom.document.body.clientHeight ) ) {
		// IE 4 compatible
		myWidth = dom.document.body.clientWidth;
		myHeight = dom.document.body.clientHeight;
	}
	return { width: myWidth, height: myHeight };
}

function getScrollXY(dom) {
	// get page scroll X, Y
	if (!dom) dom = window;
  var scrOfX = 0, scrOfY = 0;
  if( typeof( dom.pageYOffset ) == 'number' ) {
    //Netscape compliant
    scrOfY = dom.pageYOffset;
    scrOfX = dom.pageXOffset;
  } else if( dom.document.body && ( dom.document.body.scrollLeft || dom.document.body.scrollTop ) ) {
    //DOM compliant
    scrOfY = dom.document.body.scrollTop;
    scrOfX = dom.document.body.scrollLeft;
  } else if( dom.document.documentElement && ( dom.document.documentElement.scrollLeft || dom.document.documentElement.scrollTop ) ) {
    //IE6 standards compliant mode
    scrOfY = dom.document.documentElement.scrollTop;
    scrOfX = dom.document.documentElement.scrollLeft;
  }
  return { x: scrOfX, y: scrOfY };
}

function getScrollMax(dom) {
	// get maximum scroll width/height
	var myWidth = 0, myHeight = 0;
	if (dom.document.body.scrollHeight) {
		myWidth = dom.document.body.scrollWidth;
		myHeight = dom.document.body.scrollHeight;
	}
	else if (dom.document.documentElement.scrollHeight) {
		myWidth = dom.document.documentElement.scrollWidth;
		myHeight = dom.document.documentElement.scrollHeight;
	}
	return { width: myWidth, height: myHeight };
}

function safe_call(name, arg1, arg2, arg3) {
	if (window[name]) return window[name](arg1, arg2, arg3);
	else return null;
}

function hires_time_now() {
	// return the Epoch seconds for like right now
	var now = new Date();
	return ( now.getTime() / 1000 );
}

function fire_callback(callback) {
	// fire callback, which can be a function name, ref, or special object ref
	// inline arguments are passed verbatim to callback function
	var args = array_slice( arguments, 1 );
	
	if (isa_array(callback)) {
		var obj = callback[0];
		var func = callback[1];
		return obj[func].apply(obj, args);
	}
	else if (typeof(callback) == 'function') {
		return callback.apply(null, args);
	}
	else {
		return window[callback].apply(null, args);
	}
}

function fire_hook(name) {
	// fire a hook function, and delete it (one time use)
	if (session.hooks[name]) {
		var args = array_slice(arguments, 1);
		array_unshift( args, session.hooks[name] );
		fire_callback.apply(window, args);
		delete session.hooks[name];
	}
}

function str_value(str) {
	if (typeof(str) == 'undefined') str = '';
	else if (str === null) str = '';
	return '' + str;
}

function pluralize(word, num) {
	if (num != 1) return word + 's'; else return word;
}

function get_menu_value(id) {
	var menu = $(id);
	if (!menu) return '';
	return menu.options[menu.selectedIndex].value;
}

function set_menu_value(id, value, auto_add) {
	var menu = $(id);
	if (!menu) return false;
	for (var idx = 0, len = menu.options.length; idx < len; idx++) {
		if (menu.options[idx].value == value) {
			menu.selectedIndex = idx;
			return true;
		}
	}
	if (auto_add) {
		menu.options[menu.options.length] = new Option(value, value);
		menu.selectedIndex = menu.options.length - 1;
		return true;
	}
	return false;
}

function disable_menu(id) {
	var menu = $(id);
	if (!menu) return false;
	menu.disabled = true;
	menu.setAttribute( 'disabled', 'disabled' );
}

function enable_menu(id) {
	var menu = $(id);
	if (!menu) return false;
	menu.disabled = false;
	menu.setAttribute( 'disabled', '' );
}

function populate_menu(id, items, sel_value) {
	var menu = $(id);
	if (!menu) return false;
	menu.options.length = 0;
	
	for (var idx = 0, len = items.length; idx < len; idx++) {
		var item = items[idx];
		var item_name = isa_array(item) ? item[0] : item;
		var item_value = isa_array(item) ? item[1] : item;
		menu.options[ menu.options.length ] = new Option( item_name, item_value );
		if (item_value == sel_value) menu.selectedIndex = idx;
	} // foreach item
}

function dirname(path) {
	// return path excluding file at end (same as POSIX function of same name)
	return path.toString().replace(/\/$/, "").replace(/\/[^\/]+$/, "");
}

function basename(path) {
	// return filename, strip path (same as POSIX function of same name)
	return path.toString().replace(/\/$/, "").replace(/^(.*)\/([^\/]+)$/, "$2");
}

function strip_ext(path) {
	// strip extension from filename
	return path.toString().replace(/\.\w+$/, "");
}

function mm_dd_yyyy(epoch, ch) {
	if (!ch) ch = '/';
	var dargs = get_date_args(epoch);
	if (dargs.mon < 10) dargs.mon = '0' + dargs.mon;
	if (dargs.mday < 10) dargs.mday = '0' + dargs.mday;
	return dargs.year + ch + dargs.mon + ch + dargs.mday;
}

function get_nice_date(epoch, abbrev) {
	var dargs = get_date_args(epoch);
	var month = months[dargs.mon - 1][1];
	if (abbrev) month = month.substring(0, 3);
	return month + ' ' + dargs.mday + ', ' + dargs.year;
}

function get_nice_time(epoch, secs) {
	// return time in HH12:MM format
	var dargs = get_date_args(epoch);
	if (dargs.min < 10) dargs.min = '0' + dargs.min;
	if (dargs.sec < 10) dargs.sec = '0' + dargs.sec;
	var output = dargs.hour12 + ':' + dargs.min;
	if (secs) output += ':' + dargs.sec;
	output += ' ' + dargs.ampm.toUpperCase();
	return output;
}

function get_nice_date_time(epoch, secs) {
	return get_nice_date(epoch) + ' ' + get_nice_time(epoch, secs);
}

function get_short_date_time(epoch) {
	return get_nice_date(epoch, true) + ' ' + get_nice_time(epoch, false);
}

function load_script(url) {
	var scr = document.createElement('SCRIPT');
	scr.type = 'text/javascript';
	scr.src = url;
	document.getElementsByTagName('HEAD')[0].appendChild(scr);
}

function safe_query_add(url, str) {
	// safely add query param (adds '?" or '&' based on URL)
	if (url.match(/\?/)) url += '&'; else url += '?';
	return url + str;
}

function trim(str) {
	// trim whitespace from beginning and end of string
	return str.toString().replace(/^\s+/, "").replace(/\s+$/, "");
}

function compose_attribs(attribs) {
	// compose Key="Value" style attributes for HTML elements
	var html = '';
	
	if (attribs) {
		for (var key in attribs) {
			html += " " + key + "=\"" + attribs[key] + "\"";
		}
	}

	return html;
}

function compose_style(attribs) {
	// compose key:value; pairs for style (CSS) elements
	var html = '';
	
	if (attribs) {
		for (var key in attribs) {
			html += " " + key + ":" + attribs[key] + ";";
		}
	}

	return html;
}

function find_in_array(arr, elem) {
	for (var idx = 0, len = arr.length; idx < len; idx++) {
		if (arr[idx] == elem) return idx;
	}
	return -1;
}

function tiptext_field(id, class_name, attribs, style, value, tip) {
	// return HTML for text field that has tool tip which shows when the field is empty
	var html = '';
	
	if (!attribs) attribs = {};
	if (!style) style = {};
	value = str_value(value);
	
	if (value.length == 0) {
		value = tip;
		if (class_name.length) class_name += ' ';
		class_name += 'tiptext_empty';
	}
	html += '<input type="text" class="'+class_name+'" id="'+id+'" style="'+compose_style(style)+'" value="'+escape_text_field_value(value)+'" title="'+tip+'" onBlur="tiptext_blur(this)" onFocus="tiptext_focus(this)" '+compose_attribs(attribs)+'>';
	return html;
}

function tiptext_focus(obj) {
	// text has changed in tip field
	if (obj.value == obj.getAttribute('title')) obj.value = '';
	$(obj).removeClass('tiptext_empty');
}

function tiptext_blur(obj) {
	// text has changed in tip field
	if (!obj.value.length) {
		obj.value = obj.getAttribute('title');
		$(obj).addClass('tiptext_empty');
	}
	else if (obj.value != obj.getAttribute('title')) {
		$(obj).removeClass('tiptext_empty');
	}
}

function tiptext_value(id) {
	// get value from tiptext field
	var value = get_clean_field_value(id);
	if (value == $(id).getAttribute('title')) value = '';
	return value;
}

function validate_url(url) {
	// make sure URL is well-formed (this is a rather loose match)
	return !!url.match(/^(https?\:\/\/)[\w\-\.\/]+(\?\S+)?$/);
}

function format_price_usd(value, show_usd) {
	// format number to USD price: 0 == "$0.00 USD", 1.5 = "$1.50 USD"
	var matches = value.toString().match(/^(\d+)\.(\d+)$/);
	if (matches) {
		if (matches[2].length < 2) matches[2] = '0' + matches[2];
		else if (matches[2].length > 2) matches[2] = matches[2].substring(0, 2);
		return '$' + commify(matches[1]) + '.' + matches[2] + (show_usd ? ' USD' : '');
	}
	else return '$' + commify(value) + '.00' + (show_usd ? ' USD' : '');
}

function pretty_print_csv(csv) {
	// show using spaces after commas
	csv = str_value(csv);
	return csv.toString().replace(/\,(\S)/g, ", $1");
}

function blur_all_text_fields() {
	// ff must do this when divs go hidden
	var fields = document.getElementsByTagName('input');
	for (var idx = 0, len = fields.length; idx < len; idx++) {
		var field = fields[idx];
		if (field.type == 'text') field.blur();
	}
}

function escape_text_field_value(text) {
	text = encode_attrib_entities(text);
	if (ie && text.replace) text = text.replace(/\&apos\;/g, "'");
	return text;
}

function copy_to_clipboard(text) {
	// copy text to clipboard using SWF movie
	var id = 'flashcopier';
	var html = '';
	if (ie) {
		html += '<object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" codebase="'+protocol+'://fpdownload.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=8,0,0,0" width="1" height="1" id="cliptext" align="middle">';
		html += '<param name="allowScriptAccess" value="sameDomain" />';
		html += '<param name="movie" value="cliptext.swf" />';
		html += '<param name="quality" value="high" />';
		html += '<param name="bgcolor" value="#ffffff" />';
		html += '<param name="FlashVars" value="cliptext='+escape(text)+'">';
		html += '</object>';
	}
	else {
		html = '<embed src="cliptext.swf" quality="high" bgcolor="#ffffff" width="1" height="1" name="cliptext" align="middle" allowScriptAccess="sameDomain" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer"  FlashVars="cliptext='+escape(text)+'"/>';
	}

	if ($(id)) {
		try { document.getElementsByTagName('body')[0].removeChild( $(id) ); } catch(e) {};
	}

	var div = document.createElement('div');
	div.id = id;
	div.setAttribute('id', id);
	div.style.position = 'absolute';
	div.style.left = '-200px';
	div.style.top = '0px';
	div.style.width = '1px';
	div.style.height = '1px';
	div.innerHTML = html;
	
	var body = document.getElementsByTagName('body')[0];
	body.appendChild(div);
}
